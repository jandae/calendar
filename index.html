<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2025 Calendar with Events</title>
    <link rel="stylesheet" type="text/css" href="styles.css">
</head>
<body>
    <!-- New Section for Event List by Month -->
    <div class="event-list" id="event-list">
        <div id="event-list-container"></div>
    </div>

    <div class="calendar" id="calendar"></div>

    <script>
        const months = [
            "January", "February", "March", "April", "May", "June",
            "July", "August", "September", "October", "November", "December"
        ];
        const days = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
        const calendarDiv = document.getElementById('calendar');
        const eventListContainer = document.getElementById('event-list-container');

        const eventTypeColors = {
            'birthday': '#edffe3',
            'holiday': '#ffeae7',
            'anniversary': '#dfe1fa',
            'working holiday': '#ffe0b2',
            'event': '#ffcc80'
        };

        function capitalizeFirstLetter(string) {
            return string.charAt(0).toUpperCase() + string.slice(1);
        }

        function normalizeDate(month, day) {
            return `${month}-${day}`; // No padding for the month
        }

        function displayEventList(events) {
            eventListContainer.innerHTML = ''; // Clear previous list

            // Loop through all months
            for (let month = 0; month < 12; month++) {
                const monthKey = `${month + 1}`; // Month in "M" format, without padding
                const monthEvents = Object.keys(events).filter(event => event.split('-')[0] === monthKey); // Check for exact match on the month

                if (monthEvents.length) {
                    const monthDiv = document.createElement('div');
                    monthDiv.classList.add('event-month');

                    const monthTitle = document.createElement('h3');
                    monthTitle.textContent = `${months[month]}`;
                    monthDiv.appendChild(monthTitle);

                    const ul = document.createElement('ul');

                    monthEvents.forEach(eventKey => {
                        events[eventKey].forEach(event => {
                            const li = document.createElement('li');
                            let text = `${event.description}`;

                            // Add the day before the text
                            const [month, day] = eventKey.split('-'); // Extract month and day
                            const date = new Date(2025, month - 1, day); // Create date object (year is 2025)

                            // Get the day of the week in shorthand (e.g., "Mon", "Tue")
                            const dayOfWeek = days[date.getDay()];

                            text = `${day} (${dayOfWeek}) - ${text}`;

                            // Add age for birthdays
                            if (event.type === 'birthday' && event.year) {
                                const age = new Date().getFullYear() - event.year;
                                text += ` - ${age} yo`;
                            }
                            // Add years for anniversaries
                            else if (event.type === 'anniversary' && event.year) {
                                const years = new Date().getFullYear() - event.year;
                                text += ` - ${years} year${years > 1 ? 's' : ''}`;
                            }

                            // Add event type as a class to li
                            if (event.type === 'event') {
                                li.classList.add('general-event'); // For non-specific events
                            } else {
                                li.classList.add(event.type); // For specific event types
                            }

                            li.textContent = text;
                            ul.appendChild(li);
                        });
                    });

                    monthDiv.appendChild(ul);
                    eventListContainer.appendChild(monthDiv);
                }
            }
        }

        async function fetchEvents() {
            const response = await fetch('https://docs.google.com/spreadsheets/d/e/2PACX-1vSpIW6ptzBpQ6R15IlmK-bVAl4zoZ4Iyg2FOzIpBoDWT2xVNPP2YGfOqp4uAwG5lix2IW02rOJNijDX/pub?output=csv');
            const csvText = await response.text();

            const events = {};
            const rows = csvText.split('\n').slice(1);

            console.log("Fetched CSV Data:", csvText);  // Log raw CSV data

            rows.forEach(row => {
                const [timestamp, date, type, description] = row.split(',');

                if (date && description) {
                    const [month, day, year] = date.trim().split('/');
                    const formattedDate = `${month}-${day}`; // No padding for the month

                    // Check if the event already exists for the specific date and description to prevent duplicates
                    if (!events[formattedDate]) {
                        events[formattedDate] = [];
                    }

                    const eventExists = events[formattedDate].some(event => event.description === description.trim());

                    if (!eventExists) {
                        events[formattedDate].push({
                            type: type.trim().toLowerCase(),
                            description: description.trim(),
                            year: year ? parseInt(year.trim()) : null,
                        });
                    }
                }
            });

            console.log("Parsed Events:", events);  // Log events data after parsing

            return events;
        }


        async function generateCalendar(year) {
            const events = await fetchEvents();

            console.log("Events for Calendar:", events);

            for (let month = 0; month < 12; month++) {
                const firstDay = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();

                const monthDiv = document.createElement('div');
                monthDiv.classList.add('month');

                const monthTitle = document.createElement('h2');
                monthTitle.textContent = `${months[month]} ${year}`;
                monthDiv.appendChild(monthTitle);

                const table = document.createElement('table');
                const thead = document.createElement('thead');
                const tr = document.createElement('tr');

                days.forEach(day => {
                    const th = document.createElement('th');
                    th.textContent = day;
                    tr.appendChild(th);
                });

                thead.appendChild(tr);
                table.appendChild(thead);

                const tbody = document.createElement('tbody');
                let row = document.createElement('tr');

                for (let i = 0; i < firstDay; i++) {
                    const emptyCell = document.createElement('td');
                    row.appendChild(emptyCell);
                }

                for (let day = 1; day <= daysInMonth; day++) {
                    const cell = document.createElement('td');
                    cell.setAttribute('data-day', day);

                    const dayOfWeek = new Date(year, month, day).getDay();
                    if (dayOfWeek === 0 || dayOfWeek === 6) {
                        cell.classList.add('weekend');
                    }

                    const normalizedDate = normalizeDate(month + 1, day);
                    if (events[normalizedDate]) {
                        const eventList = events[normalizedDate];
                         if (eventList.length > 1) {
                             // For multiple events, display each event with individual background colors
                            eventList.forEach(event => {
                                const eventDiv = document.createElement('div');
                                eventDiv.textContent = event.description;
                                eventDiv.style.backgroundColor = eventTypeColors[event.type] || '#fff';
                                eventDiv.style.marginBottom = '5px'; // Space between events
                                eventDiv.style.padding = '2px';
                                eventDiv.style.borderRadius = '4px';

                                if (event.year) {
                                    const years = year - event.year;
                                    if (event.type === 'birthday') {
                                        eventDiv.textContent += ` (${years} yo)`;
                                    } else if (event.type === 'anniversary') {
                                        eventDiv.textContent += ` (${years} year${years > 1 ? 's' : ''})`;
                                    }
                                }

                                cell.appendChild(eventDiv);
                            });
                         }
                         else {
                             events[normalizedDate].forEach(event => {
                                 if (event.type === 'birthday') {
                                     cell.classList.add('birthday-cell');
                                     const eventDiv = document.createElement('div');
                                     eventDiv.classList.add('event-birthday');
                                     const descriptionSpan = document.createElement('span');
                                     descriptionSpan.textContent = event.description;

                                     const ageSpan = document.createElement('span');
                                     const age = event.year ? ` ${year - event.year} yo` : '';
                                     ageSpan.textContent = age;

                                     eventDiv.appendChild(descriptionSpan);
                                     eventDiv.appendChild(ageSpan);

                                     cell.appendChild(eventDiv);
                                 } else if (event.type === 'holiday') {
                                     cell.classList.add('holiday-cell');
                                     const eventDiv = document.createElement('div');
                                     eventDiv.classList.add('event-holiday');
                                     eventDiv.textContent = event.description;
                                     cell.appendChild(eventDiv);
                                 } else if (event.type === 'anniversary') {
                                     cell.classList.add('anniversary-cell');
                                     const eventDiv = document.createElement('div');
                                     eventDiv.classList.add('event-anniversary');
                                     const descriptionSpan = document.createElement('span');
                                     descriptionSpan.textContent = event.description;

                                     const yearsSpan = document.createElement('span');
                                     const years = event.year ? `${year - event.year} year${(year - event.year) > 1 ? 's' : ''}` : '';
                                     yearsSpan.textContent = ` ${years}`;

                                     eventDiv.appendChild(descriptionSpan);
                                     eventDiv.appendChild(yearsSpan);

                                     cell.appendChild(eventDiv);
                                 } else if (event.type === 'working holiday') {
                                     cell.classList.add('working-holiday-cell');
                                     const eventDiv = document.createElement('div');
                                     eventDiv.classList.add('event-working-holiday');
                                     eventDiv.textContent = event.description;
                                     cell.appendChild(eventDiv);
                                 } else {
                                     cell.classList.add('event-cell');
                                     const eventDiv = document.createElement('div');
                                     eventDiv.classList.add('event');
                                     eventDiv.textContent = event.description;
                                     cell.appendChild(eventDiv);
                                 }
                             });
                         }
                    }

                    row.appendChild(cell);

                    if ((firstDay + day) % 7 === 0) {
                        tbody.appendChild(row);
                        row = document.createElement('tr');
                    }
                }

                tbody.appendChild(row);
                table.appendChild(tbody);
                monthDiv.appendChild(table);
                calendarDiv.appendChild(monthDiv);
            }
            console.log(events)
            displayEventList(events);
        }

        generateCalendar(2025);
    </script>
</body>
</html>
